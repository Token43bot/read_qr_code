<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR → Spotify (Minimal)</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; }
    #app { display:flex; flex-direction:column; height:100%; }
    #scanner { flex:1; position:relative; }
    #bar { display:flex; gap:12px; padding:12px; background:rgba(0,0,0,.6); }
    button { flex:1; height:48px; font-size:16px; border:none; border-radius:10px; background:#222; color:#fff; }
    #hint { position:fixed; top:10px; left:0; right:0; text-align:center; color:#bbb; font-size:14px; }
    #overlay { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.75); }
    #startBtn { padding:14px 18px; border-radius:12px; }
    #msg { position:fixed; bottom:68px; left:0; right:0; text-align:center; color:#9f9; font-size:13px; padding:6px 10px; }
  </style>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
  <div id="app">
    <div id="hint">Kamera auf QR halten – nach Treffer öffnet sich Spotify. Diese Seite bleibt offen.</div>
    <div id="scanner">
      <div id="overlay"><button id="startBtn">Kamera starten</button></div>
    </div>
    <div id="bar">
      <button id="rescan" disabled>Erneut scannen</button>
      <button id="switch" disabled>Kamera wechseln</button>
    </div>
    <div id="msg"></div>
  </div>

  <script>
    let qr, cams = [], currentIdx = 0;
    let cooldown = false;                     // Entprellung für Mehrfach-Treffer
    const COOLDOWN_MS = 2500;

    const $overlay = document.getElementById('overlay');
    const $startBtn = document.getElementById('startBtn');
    const $rescan = document.getElementById('rescan');
    const $switch = document.getElementById('switch');
    const $msg = document.getElementById('msg');

    function toast(t){ $msg.textContent = t; setTimeout(()=> $msg.textContent='', 2000); }

    function extractTrackId(text) {
      text = text.trim();
      if (text.startsWith("spotify:track:")) return text.split("spotify:track:")[1];
      const m = text.match(/open\.spotify\.com\/track\/([A-Za-z0-9]+)\b/);
      return m ? m[1] : null;
    }

    // Öffnet eine URL/Intent OHNE die aktuelle Seite zu entladen
    function openExternal(href) {
      const a = document.createElement('a');
      a.href = href;
      a.target = '_blank';        // neuer Kontext/App-Switch
      a.rel = 'noopener noreferrer';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function launchSpotifyFromId(id) {
      // 1) Intent (Android App), 2) Spotify-Schema, 3) HTTPS – alle im neuen Kontext
      openExternal(`intent://open.spotify.com/track/${id}#Intent;scheme=https;package=com.spotify.music;end`);
      setTimeout(() => openExternal(`spotify:track:${id}`), 300);
      setTimeout(() => openExternal(`https://open.spotify.com/track/${id}`), 600);
    }

    function launchSpotify(text) {
      const id = extractTrackId(text);
      if (id) launchSpotifyFromId(id); else openExternal(text);
    }

    async function askCameraPermission() {
      const s = await navigator.mediaDevices.getUserMedia({ video: true });
      s.getTracks().forEach(t => t.stop());
    }

    async function listCameras() {
      try { cams = await Html5Qrcode.getCameras(); }
      catch (_) { cams = await Html5Qrcode.getCameras(); }
      if (!cams.length) throw new Error('Keine Kamera gefunden.');
      const backIdx = cams.findIndex(c => /back|rear|environment/i.test(c.label));
      currentIdx = backIdx >= 0 ? backIdx : 0;
    }

    async function startWithCurrentCam() {
      if (!qr) qr = new Html5Qrcode("scanner", false);
      const deviceId = cams[currentIdx].id;
      const cfg = { fps: 15, qrbox: { width: 300, height: 300 } };
      await qr.start({ deviceId: { exact: deviceId } }, cfg, onScan, () => {});
      $overlay.style.display = 'none';
      $rescan.disabled = false;
      $switch.disabled = cams.length <= 1;
      toast('Scanner bereit');
    }

    async function stopScanner(){ try { await qr?.stop(); } catch(_) {} }

    async function onScan(text) {
      if (cooldown) return;            // denselben Code nicht mehrfach zünden
      cooldown = true;
      setTimeout(() => cooldown = false, COOLDOWN_MS);

      launchSpotify(text);             // öffnet App/Link in neuem Kontext
      // Scanner bleibt aktiv – Seite wird nicht navigiert.
      toast('Öffne Spotify …');
    }

    async function startFlow() {
      try {
        await askCameraPermission();
        await listCameras();
        await startWithCurrentCam();
      } catch (e) {
        $overlay.style.display = '';
        alert('Kamera-Zugriff verweigert oder nicht verfügbar. Bitte im Schloss-Symbol → Website-Einstellungen → Kamera → Zulassen.');
      }
    }

    // UI Events
    $startBtn.addEventListener('click', startFlow);
    $rescan.addEventListener('click', async () => { /* nichts nötig – Scanner läuft */ toast('Bereit zum Scannen'); });
    $switch.addEventListener('click', async () => {
      currentIdx = (currentIdx + 1) % cams.length;
      await stopScanner();
      await startWithCurrentCam();
    });

    // Bei Rückkehr aus Spotify: einfach weiter scannen
    document.addEventListener('visibilitychange', () => {
      // Nichts tun – Scanner läuft weiter; wir resetten nur die Entprellung.
      if (!document.hidden) cooldown = false;
    });

    // Auto-Start
    window.addEventListener('load', () => { startFlow(); });
  </script>
</body>
</html>
