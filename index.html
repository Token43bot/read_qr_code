<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR â†’ Spotify (Minimal)</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; }
    #app { display:flex; flex-direction:column; height:100%; }
    #scanner { flex:1; }
    #bar { display:flex; gap:12px; padding:12px; background:rgba(0,0,0,.6); }
    button { flex:1; height:48px; font-size:16px; border:none; border-radius:10px; background:#222; color:#fff; }
    #hint { position:fixed; top:10px; left:0; right:0; text-align:center; color:#bbb; font-size:14px; }
    #startWrap { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.85); }
    #startBtn { padding:14px 18px; border-radius:12px; }
  </style>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
  <div id="app">
    <div id="hint">Kamera auf QR halten â€“ nach Treffer wird Spotify geÃ¶ffnet.</div>
    <div id="scanner"></div>
    <div id="bar">
      <button id="rescan" disabled>Erneut scannen</button>
    </div>
  </div>

  <!-- Wird nur gezeigt, wenn Auto-Start ohne Berechtigung scheitert -->
  <div id="startWrap" hidden>
    <button id="startBtn">Kamera starten</button>
  </div>

  <script>
    let qr;
    const $rescan = document.getElementById('rescan');
    const $startWrap = document.getElementById('startWrap');
    const $startBtn  = document.getElementById('startBtn');

    function extractTrackId(text) {
      text = text.trim();
      if (text.startsWith("spotify:track:")) return text.split("spotify:track:")[1];
      const m = text.match(/open\.spotify\.com\/track\/([A-Za-z0-9]+)\b/);
      return m ? m[1] : null;
    }

    async function startScanner() {
      if (!qr) qr = new Html5Qrcode("scanner", false);
      const cfg = { fps: 15, qrbox: { width: 300, height: 300 } };
      // Wichtig: keine Kameraliste â€“ direkt um RÃ¼ckkamera bitten
      await qr.start({ facingMode: "environment" }, cfg, onScan, () => {});
      $rescan.disabled = true;
      $startWrap.hidden = true;
    }

    async function stopScanner() {
      try { await qr?.stop(); } catch(e) {}
    }

    async function onScan(text) {
      await stopScanner();
      $rescan.disabled = false;

      const id = extractTrackId(text);
      if (id) {
        // App Ã¶ffnen (Intent), dann spotify:, dann https â€“ beste Chance, direkt die Spotify-App zu starten
        const intentUrl = `intent://open.spotify.com/track/${id}#Intent;scheme=https;package=com.spotify.music;end`;
        try { location.replace(intentUrl); } catch(e) {}
        setTimeout(() => { try { location.replace(`spotify:track:${id}`); } catch(e) {} }, 600);
        setTimeout(() => { try { location.replace(`https://open.spotify.com/track/${id}`); } catch(e) {} }, 1200);
      } else {
        try { location.replace(text); } catch(e) {}
      }
    }

    // Buttons
    $rescan.addEventListener('click', async () => { await startScanner(); });
    $startBtn.addEventListener('click', async () => {
      try { await startScanner(); }
      catch(e) { alert("Kamera-Zugriff verweigert. Bitte Kamera erlauben (ðŸ”’â†’ Website-Einstellungen â†’ Kamera â†’ Zulassen) und die Seite neu laden."); }
    });

    // Auto-Start (zeigt bei Fehler den Start-Button mit Anleitung)
    (async () => {
      try {
        // Einige Browser fragen erst nach Interaktion â€“ wir probieren es trotzdem:
        await startScanner();
      } catch (e) {
        $startWrap.hidden = false;
        // Kleiner Hinweis bei harter Sperre:
        // console.warn(e);
      }
    })();
  </script>
</body>
</html>
