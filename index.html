<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR → Spotify (Minimal)</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; }
    #app { display:flex; flex-direction:column; height:100%; }
    #scanner { flex:1; }
    #bar { display:flex; gap:12px; padding:12px; background:rgba(0,0,0,.6); }
    button { flex:1; height:48px; font-size:16px; border:none; border-radius:10px; background:#222; color:#fff; }
    #hint { position:fixed; top:10px; left:0; right:0; text-align:center; color:#bbb; font-size:14px; }
  </style>
  <!-- QR-Scanner Bibliothek (CDN) -->
  <script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
  <div id="app">
    <div id="hint">Kamera auf QR halten – nach Treffer wird Spotify geöffnet.</div>
    <div id="scanner"></div>
    <div id="bar">
      <button id="rescan" disabled>Erneut scannen</button>
    </div>
  </div>

  <script>
    let qr, currentCamId = null, cams = [];
    const $rescan = document.getElementById('rescan');

    function extractTrackId(text) {
      // akzeptiert spotify:track:ID oder https://open.spotify.com/track/ID
      text = text.trim();
      if (text.startsWith("spotify:track:")) return text.split("spotify:track:")[1];
      const m = text.match(/open\.spotify\.com\/track\/([A-Za-z0-9]+)\b/);
      return m ? m[1] : null;
    }

    async function startScanner(deviceId = null) {
      if (!qr) qr = new Html5Qrcode("scanner", false);
      const cfg = { fps: 15, qrbox: { width: 300, height: 300 } };
      const camCfg = deviceId ? { deviceId: { exact: deviceId } } : { facingMode: "environment" };
      await qr.start(camCfg, cfg, onScan, () => {});
      $rescan.disabled = true;
    }

    async function stopScanner() {
      try { await qr?.stop(); } catch(e) {}
    }

    async function onScan(text) {
      await stopScanner();
      $rescan.disabled = false;

      const id = extractTrackId(text);
      if (id) {
        // Android: Intent-URL → öffnet direkt die Spotify-App
        const intentUrl = `intent://open.spotify.com/track/${id}#Intent;scheme=https;package=com.spotify.music;end`;
        // Fallback-Kaskade: intent -> spotify: -> https
        try { location.replace(intentUrl); } catch(e) {}
        setTimeout(() => { try { location.replace(`spotify:track:${id}`); } catch(e) {} }, 600);
        setTimeout(() => { try { location.replace(`https://open.spotify.com/track/${id}`); } catch(e) {} }, 1200);
      } else {
        // Unbekanntes Format → einfach öffnen (Spotify regelt ggf. selbst)
        try { location.replace(text); } catch(e) {}
      }
    }

    // Button: Erneut scannen
    document.getElementById('rescan').addEventListener('click', async () => {
      await startScanner(currentCamId);
    });

    // Init
    (async () => {
      try {
        cams = (await Html5Qrcode.getCameras());
        currentCamId = (cams.find(c => /back|rear/i.test(c.label))?.id) || cams[0]?.id || null;
        await startScanner(currentCamId);
      } catch(e) {
        alert("Kamera-Zugriff fehlgeschlagen. Öffne die Seite über HTTPS (oder http://localhost) und erlaube die Kamera.");
      }
    })();
  </script>
</body>
</html>
