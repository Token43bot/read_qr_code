<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR → Spotify (Minimal)</title>
  <style>
    html, body { margin:0; padding:0; background:#000; height:100%; }
    #app { display:flex; flex-direction:column; height:100%; }
    #scanner { flex:1; }
    #controls {
      display:flex; gap:12px; padding:12px; background:rgba(0,0,0,0.6);
    }
    button {
      flex:1; height:48px; font-size:16px; border:none; border-radius:10px;
      background:#222; color:#fff;
    }
    #hint { position:fixed; top:10px; left:0; right:0; text-align:center; color:#bbb; font-size:14px; }
  </style>
  <!-- html5-qrcode über CDN -->
  <script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
  <div id="app">
    <div id="hint">Kamera auf QR halten – nach Treffer wird Spotify geöffnet.</div>
    <div id="scanner"></div>
    <div id="controls">
      <button id="rescan" disabled>Erneut scannen</button>
      <button id="torch" disabled>Taschenlampe</button>
      <button id="cam" disabled>Kamera wechseln</button>
    </div>
  </div>

  <script>
    let html5QrCode;
    let currentCamId = null;
    let cameras = [];
    let torchOn = false;
    const $rescan = document.getElementById('rescan');
    const $torch = document.getElementById('torch');
    const $cam   = document.getElementById('cam');

    // Hilfsfunktionen
    function toSpotifyUri(text) {
      // Akzeptiert spotify:track:ID oder https://open.spotify.com/track/ID
      if (text.startsWith("spotify:track:")) return text;
      if (text.includes("open.spotify.com/track/")) {
        const id = text.split("/track/")[1]?.split("?")[0];
        if (id) return `spotify:track:${id}`;
      }
      // Wenn kein Track-Format: Link einfach öffnen (Spotify regelt)
      return text;
    }

    async function startScanner(deviceId = null) {
      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("scanner", /* verbose */ false);
      }
      const config = { fps: 15, qrbox: { width: 300, height: 300 }, aspectRatio: 1.777 };
      const cameraConfig = deviceId ? { deviceId: { exact: deviceId } } : { facingMode: "environment" };

      await html5QrCode.start(
        cameraConfig,
        config,
        (decodedText) => onScan(decodedText),
        (errMsg) => { /* ignore */ }
      );

      // Torch & Cam Controls
      try {
        const track = html5QrCode.getState() === Html5QrcodeScannerState.SCANNING
          ? html5QrCode.getRunningTrackCameraCapabilities()
          : null;
      } catch(e) { /* ignore */ }

      $rescan.disabled = true;
      $torch.disabled = false;
      $cam.disabled = cameras.length <= 1;
    }

    function stopScanner() {
      return html5QrCode?.stop().catch(()=>{});
    }

    async function onScan(text) {
      await stopScanner();              // Sofort stoppen, damit nicht mehrfach ausgelöst wird
      $rescan.disabled = false;

      const uri = toSpotifyUri(text.trim());

      // Android: spotify:track:… öffnet direkt die App
      // Alternativ immer https-Link verwenden:
      if (uri.startsWith("spotify:track:")) {
        window.location.href = uri;
      } else if (/^https?:\/\//i.test(uri)) {
        window.location.href = uri;
      } else {
        // Fallback: als Suchlink öffnen
        window.location.href = "https://open.spotify.com/search/" + encodeURIComponent(text);
      }
    }

    // Taschenlampe togglen (wenn vom Gerät unterstützt)
    async function toggleTorch() {
      try {
        const stream = html5QrCode.getState() === 2 /* SCANNING */ ? html5QrCode.getRunningStream() : null;
        if (!stream) return;
        const track = stream.getVideoTracks()[0];
        const caps = track.getCapabilities?.() || {};
        if (!caps.torch) return; // nicht unterstützt
        torchOn = !torchOn;
        await track.applyConstraints({ advanced: [{ torch: torchOn }] });
        $torch.textContent = torchOn ? "Taschenlampe AUS" : "Taschenlampe";
      } catch(e) {
        // ignorieren
      }
    }

    async function switchCamera() {
      if (cameras.length <= 1) return;
      const idx = cameras.findIndex(c => c.id === currentCamId);
      const next = cameras[(idx + 1) % cameras.length];
      currentCamId = next.id;
      await stopScanner();
      await startScanner(currentCamId);
    }

    // Event-Handler
    $rescan.addEventListener('click', async () => {
      await startScanner(currentCamId);
    });
    $torch.addEventListener('click', toggleTorch);
    $cam.addEventListener('click', switchCamera);

    // Init
    (async () => {
      try {
        cameras = (await Html5Qrcode.getCameras()).map(c => ({ id: c.id, label: c.label }));
        currentCamId = cameras.find(c => /back|rear/i.test(c.label))?.id || cameras[0]?.id || null;
        await startScanner(currentCamId);
        $cam.disabled = cameras.length <= 1;
      } catch(e) {
        alert("Kamera-Zugriff fehlgeschlagen. Öffne diese Seite über HTTPS oder http://localhost und erlaube die Kamera.");
      }
    })();
  </script>
</body>
</html>
